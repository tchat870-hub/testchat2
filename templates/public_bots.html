{% extends 'layout.html' %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-2 text-white">Public Bots</h1>
    <p class="text-lg text-gray-400 mb-6">Find a bot to start your own story.</p>

    <div class="bg-gray-800 p-6 rounded-lg shadow-xl mb-8">
        <h2 class="text-2xl font-semibold mb-4 text-white">Join a Friend's Room</h2>
        <form action="{{ url_for('join_room') }}" method="POST" class="flex flex-col sm:flex-row gap-4">
            <input type="text" name="room_code" placeholder="Enter Room Code" required
                class="flex-grow p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" class="p-3 px-6 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200">
                Join by Code
            </button>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% if bots %}
            {% for bot in bots %}
            <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col">
                <img src="{{ bot.bot_image_url | default('https://placehold.co/400x300/4a5568/FFFFFF?text=Bot', true) }}" 
                    alt="{{ bot.bot_name }}" class="w-full h-48 object-cover cursor-pointer" onclick="openImageModal(this.src)">
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="text-xl font-bold text-white mb-1">{{ bot.bot_name }}</h3>
                    <p class="text-sm text-gray-400 mb-3">by {{ bot.owner_display_name | default('N/A') }}</p>
                    
                    <p class="text-gray-300 text-sm mb-4 h-16 overflow-y-auto pr-1 custom-scrollbar">
                        {{ bot.start_scenario }}
                    </p>
                    
                    {% if active_sessions is defined and bot.id in active_sessions %}
                        <a href="{{ url_for('chat_room', room_code=active_sessions[bot.id]) }}" 
                           class="mt-auto text-center w-full p-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition duration-200 flex justify-center items-center gap-2">
                            <span>▶</span> Resume Game
                        </a>
                    {% else %}
                        <button onclick="openGameSetup(this)" 
                           data-id="{{ bot.id }}" 
                           data-name="{{ bot.bot_name }}"
                           class="mt-auto text-center w-full p-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-200">
                            Start Chat (Host)
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-gray-400">No public bots found.</p>
        {% endif %}
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1); 
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #4b5563; 
        border-radius: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #6b7280; 
    }
</style>

<div id="setup-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full border border-gray-700 overflow-hidden">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-white mb-2">Setup Game: <span id="modal-bot-name" class="text-indigo-400"></span></h2>
            <p class="text-gray-400 text-sm mb-6">Choose how you want to play this story.</p>

            <form action="{{ url_for('join_room') }}" method="POST" id="setup-form">
                <input type="hidden" name="room_code" id="modal-room-code">
                <input type="hidden" name="mode" value="new">
                
                <div class="mb-4 p-4 border border-gray-600 rounded-lg hover:bg-gray-700 transition cursor-pointer" onclick="selectOption('public')">
                    <div class="flex items-center mb-2">
                        <input type="radio" name="privacy" value="public" id="opt-public" checked class="w-5 h-5 text-blue-600">
                        <label for="opt-public" class="ml-3 text-lg font-bold text-white cursor-pointer">Public Game</label>
                    </div>
                    <p class="text-sm text-gray-400 ml-8">
                        Standard rules. Anyone can join. 
                        <br><strong>Model:</strong> Standard. <span class="text-green-400">Win to unlock Pro.</span>
                    </p>
                </div>

                <div class="mb-6 p-4 border border-gray-600 rounded-lg hover:bg-gray-700 transition cursor-pointer" onclick="selectOption('private')">
                    <div class="flex items-center mb-2">
                        <input type="radio" name="privacy" value="private" id="opt-private" class="w-5 h-5 text-purple-600">
                        <label for="opt-private" class="ml-3 text-lg font-bold text-white cursor-pointer">Private Solo Session</label>
                    </div>
                    <p class="text-sm text-gray-400 ml-8 mb-3">
                        Only you can access this chat.
                    </p>
                    
                    <div id="model-select-area" class="ml-8 hidden transition-all">
                        <label class="block text-xs uppercase text-gray-500 font-bold mb-1">Choose Your AI Model</label>
                        <select name="initial_model" class="w-full p-2 bg-gray-900 border border-gray-600 rounded text-white text-sm focus:ring-2 focus:ring-purple-500">
                            <option value="flash">Standard (Gemini Flash)</option>
                            <option value="pro">Pro (Dolphin Mistral) - Unfiltered</option>
                        </select>
                        <p class="text-xs text-yellow-400 mt-2">
                            ⚠️ In Private Mode, the model is locked. Winning will not change it.
                        </p>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeSetupModal()" class="px-4 py-2 text-gray-300 hover:text-white">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white font-bold rounded hover:bg-green-700">Start Game</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Define elements outside function to ensure they exist
    const setupModal = document.getElementById('setup-modal');
    const modalBotName = document.getElementById('modal-bot-name');
    const modalRoomCode = document.getElementById('modal-room-code');
    const modelSelectArea = document.getElementById('model-select-area');
    const optPublic = document.getElementById('opt-public');
    const optPrivate = document.getElementById('opt-private');

    function openGameSetup(btn) {
        // Safe data access
        const botId = btn.dataset.id;
        const botName = btn.dataset.name;

        modalBotName.textContent = botName;
        modalRoomCode.value = botId;
        setupModal.classList.remove('hidden');
        selectOption('public'); // Reset to default
    }

    function closeSetupModal() {
        setupModal.classList.add('hidden');
    }

    function selectOption(type) {
        if(type === 'public') {
            optPublic.checked = true;
            modelSelectArea.classList.add('hidden');
        } else {
            optPrivate.checked = true;
            modelSelectArea.classList.remove('hidden');
        }
    }
    
    // Close on outside click
    if (setupModal) {
        setupModal.addEventListener('click', (e) => {
            if (e.target === setupModal) closeSetupModal();
        });
    }
</script>
{% endblock %}
